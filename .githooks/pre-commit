#!/bin/bash
#
# Git Pre-Commit Hook
# ====================
#
# This hook runs before each commit to ensure code quality.
# Install: ln -s ../../.githooks/pre-commit .git/hooks/pre-commit
#

set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track failures
FAILED=0

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# ====================
# 1. Linting
# ====================
echo "1ï¸âƒ£  Linting with Ruff..."
if ruff check src/ tests/ --fix; then
    print_status $GREEN "âœ“ Ruff linting passed"
else
    print_status $RED "âœ— Ruff linting failed"
    FAILED=1
fi
echo ""

# ====================
# 2. Formatting
# ====================
echo "2ï¸âƒ£  Checking formatting with Ruff..."
if ruff format --check src/ tests/; then
    print_status $GREEN "âœ“ Formatting check passed"
else
    print_status $YELLOW "âš  Formatting issues found. Auto-formatting..."
    ruff format src/ tests/
    print_status $YELLOW "â„¹ Please review auto-formatted files and stage them"
    FAILED=1
fi
echo ""

# ====================
# 3. Type Checking (optional)
# ====================
echo "3ï¸âƒ£  Type checking with MyPy..."
if mypy src/ --ignore-missing-imports --no-strict-optional; then
    print_status $GREEN "âœ“ Type checking passed"
else
    print_status $YELLOW "âš  Type checking found issues (non-blocking)"
fi
echo ""

# ====================
# 4. Security Scan
# ====================
echo "4ï¸âƒ£  Security scan with Bandit..."
if bandit -r src/ -ll -q; then
    print_status $GREEN "âœ“ Security scan passed"
else
    print_status $YELLOW "âš  Security issues found (review recommended)"
fi
echo ""

# ====================
# 5. Quick Tests
# ====================
echo "5ï¸âƒ£  Running quick tests..."
if pytest tests/ -v --tb=short -m "not slow and not integration" --maxfail=5 -q; then
    print_status $GREEN "âœ“ Quick tests passed"
else
    print_status $RED "âœ— Tests failed"
    FAILED=1
fi
echo ""

# ====================
# 6. Coverage Check (optional)
# ====================
if [ "${SKIP_COVERAGE:-0}" = "0" ]; then
    echo "6ï¸âƒ£  Checking coverage..."
    if pytest tests/ --cov=src --cov-fail-under=85 --cov-report=term-missing --tb=short -q 2>/dev/null; then
        print_status $GREEN "âœ“ Coverage above 85%"
    else
        print_status $YELLOW "âš  Coverage below 85% (warning)"
    fi
    echo ""
fi

# ====================
# Final Status
# ====================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
    print_status $GREEN "âœ… All pre-commit checks passed!"
    echo ""
    print_status $GREEN "Ready to commit ğŸš€"
    exit 0
else
    print_status $RED "âŒ Some checks failed!"
    echo ""
    print_status $RED "Please fix the issues above before committing."
    echo ""
    print_status $YELLOW "To skip checks (not recommended): git commit --no-verify"
    exit 1
fi


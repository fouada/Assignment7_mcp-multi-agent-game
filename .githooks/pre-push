#!/bin/bash
#
# Git Pre-Push Hook
# =================
#
# This hook runs before pushing to ensure all tests pass.
# Install: ln -s ../../.githooks/pre-push .git/hooks/pre-push
#

set -e

echo "ğŸš€ Running pre-push checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Track failures
FAILED=0

# ====================
# 1. Full Test Suite
# ====================
echo "1ï¸âƒ£  Running full test suite..."
if pytest tests/ -v --tb=short; then
    print_status $GREEN "âœ“ All tests passed"
else
    print_status $RED "âœ— Some tests failed"
    FAILED=1
fi
echo ""

# ====================
# 2. Coverage Check
# ====================
echo "2ï¸âƒ£  Checking test coverage..."
if pytest tests/ --cov=src --cov-fail-under=85 --cov-report=term-missing; then
    print_status $GREEN "âœ“ Coverage above 85%"
else
    print_status $RED "âœ— Coverage below 85%"
    FAILED=1
fi
echo ""

# ====================
# 3. Integration Tests
# ====================
echo "3ï¸âƒ£  Running integration tests..."
if pytest tests/ -v -m integration --tb=short; then
    print_status $GREEN "âœ“ Integration tests passed"
else
    print_status $YELLOW "âš  Integration tests failed (check if services are running)"
fi
echo ""

# ====================
# 4. Security Scan
# ====================
echo "4ï¸âƒ£  Running security scan..."
if bandit -r src/ -ll; then
    print_status $GREEN "âœ“ No security issues found"
else
    print_status $YELLOW "âš  Security issues detected (review recommended)"
fi
echo ""

# ====================
# 5. Dependency Check
# ====================
echo "5ï¸âƒ£  Checking dependencies..."
if pip check 2>/dev/null; then
    print_status $GREEN "âœ“ No dependency conflicts"
else
    print_status $YELLOW "âš  Dependency issues detected"
fi
echo ""

# ====================
# Final Status
# ====================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
    print_status $GREEN "âœ… All pre-push checks passed!"
    echo ""
    print_status $GREEN "Safe to push ğŸš€"
    exit 0
else
    print_status $RED "âŒ Some checks failed!"
    echo ""
    print_status $RED "Please fix the issues above before pushing."
    echo ""
    print_status $YELLOW "To skip checks (not recommended): git push --no-verify"
    exit 1
fi

